name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build Release Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Verify WAR file
        run: |
          if [ -f "target/vulnerable-app.war" ]; then
            echo "âœ… WAR file created successfully"
            ls -lh target/vulnerable-app.war
          else
            echo "âŒ WAR file not found"
            exit 1
          fi

      - name: Create release directory
        run: mkdir -p release

      - name: Rename WAR with version
        run: cp target/vulnerable-app.war release/vulnerable-app-${{ steps.version.outputs.VERSION }}.war

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: vulnerable-web-app:${{ steps.version.outputs.VERSION }}
          outputs: type=docker,dest=/tmp/vulnerable-web-app.tar

      - name: Copy Docker image to release
        run: cp /tmp/vulnerable-web-app.tar release/vulnerable-web-app-${{ steps.version.outputs.VERSION }}-docker.tar

      - name: Generate checksums
        working-directory: release
        run: |
          sha256sum vulnerable-app-${{ steps.version.outputs.VERSION }}.war > checksums.txt
          sha256sum vulnerable-web-app-${{ steps.version.outputs.VERSION }}-docker.tar >> checksums.txt
          cat checksums.txt

      - name: Create release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          # ðŸ‡«ðŸ‡· Version FranÃ§aise

          ## Release v${{ steps.version.outputs.VERSION }}

          ### ðŸ“‹ RÃ©sumÃ©

          Application Web VulnÃ©rable pour les tests de sÃ©curitÃ© applicative. Cette application implÃ©mente intentionnellement les 10 vulnÃ©rabilitÃ©s critiques du OWASP Top 10 (2021).

          ### âœ¨ FonctionnalitÃ©s

          **VulnÃ©rabilitÃ©s OWASP Top 10 ImplÃ©mentÃ©es :**
          - âœ… A01:2021 - Broken Access Control
          - âœ… A02:2021 - Cryptographic Failures
          - âœ… A03:2021 - Injection (SQL, XSS, Command)
          - âœ… A04:2021 - Insecure Design (XXE)
          - âœ… A05:2021 - Security Misconfiguration
          - âœ… A06:2021 - Vulnerable Components (Log4Shell)
          - âœ… A07:2021 - Authentication Failures
          - âœ… A08:2021 - Data Integrity Failures
          - âœ… A09:2021 - Logging Failures
          - âœ… Bonus - Path Traversal, File Upload, Command Injection

          ### ðŸ“¦ Installation

          ```bash
          # Option 1: WAR file
          cp vulnerable-app-${{ steps.version.outputs.VERSION }}.war /path/to/tomcat/webapps/

          # Option 2: Docker
          docker load -i vulnerable-web-app-${{ steps.version.outputs.VERSION }}-docker.tar
          docker run -d -p 8080:8080 vulnerable-web-app:${{ steps.version.outputs.VERSION }}
          ```

          ### âš ï¸ Avertissement

          **NE JAMAIS dÃ©ployer en production ou exposer sur Internet !**

          ### ðŸ“š Documentation

          - [README.md](README.md)
          - [VULNERABILITIES-SUMMARY.md](VULNERABILITIES-SUMMARY.md)
          - [RELEASE-INSTRUCTIONS.md](RELEASE-INSTRUCTIONS.md)

          ---

          # ðŸ‡¬ðŸ‡§ English Version

          ## Release v${{ steps.version.outputs.VERSION }}

          ### ðŸ“‹ Summary

          Vulnerable Web Application for application security testing. This application intentionally implements the 10 critical vulnerabilities from OWASP Top 10 (2021).

          ### âœ¨ Features

          **OWASP Top 10 Vulnerabilities Implemented:**
          - âœ… A01:2021 - Broken Access Control
          - âœ… A02:2021 - Cryptographic Failures
          - âœ… A03:2021 - Injection (SQL, XSS, Command)
          - âœ… A04:2021 - Insecure Design (XXE)
          - âœ… A05:2021 - Security Misconfiguration
          - âœ… A06:2021 - Vulnerable Components (Log4Shell)
          - âœ… A07:2021 - Authentication Failures
          - âœ… A08:2021 - Data Integrity Failures
          - âœ… A09:2021 - Logging Failures
          - âœ… Bonus - Path Traversal, File Upload, Command Injection

          ### ðŸ“¦ Installation

          ```bash
          # Option 1: WAR file
          cp vulnerable-app-${{ steps.version.outputs.VERSION }}.war /path/to/tomcat/webapps/

          # Option 2: Docker
          docker load -i vulnerable-web-app-${{ steps.version.outputs.VERSION }}-docker.tar
          docker run -d -p 8080:8080 vulnerable-web-app:${{ steps.version.outputs.VERSION }}
          ```

          ### âš ï¸ Warning

          **NEVER deploy to production or expose to the Internet!**

          ### ðŸ“š Documentation

          - [README.md](README.md)
          - [VULNERABILITIES-SUMMARY.md](VULNERABILITIES-SUMMARY.md)
          - [RELEASE-INSTRUCTIONS.md](RELEASE-INSTRUCTIONS.md)

          ---

          ## ðŸ”’ Checksums (SHA256)

          ```
          $(cat release/checksums.txt)
          ```

          ## ðŸ“Š Build Information

          - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Java Version**: 11
          - **Maven Version**: $(mvn -version | head -n 1)
          - **Commit**: ${{ github.sha }}
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/vulnerable-app-${{ steps.version.outputs.VERSION }}.war
            release/vulnerable-web-app-${{ steps.version.outputs.VERSION }}-docker.tar
            release/checksums.txt
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## âœ… Release v${{ steps.version.outputs.VERSION }} Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "- WAR file: vulnerable-app-${{ steps.version.outputs.VERSION }}.war" >> $GITHUB_STEP_SUMMARY
          echo "- Docker image: vulnerable-web-app-${{ steps.version.outputs.VERSION }}-docker.tar" >> $GITHUB_STEP_SUMMARY
          echo "- Checksums: checksums.txt" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š File Sizes:" >> $GITHUB_STEP_SUMMARY
          ls -lh release/ >> $GITHUB_STEP_SUMMARY
